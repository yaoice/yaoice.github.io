<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="爱折腾的工程师"><meta property="og:type" content="article"><meta property="og:image" content="https://www.iceyao.com.cn//img/post-bg-unix-linux.jpg"><meta property="twitter:image" content="https://www.iceyao.com.cn//img/post-bg-unix-linux.jpg"><meta name=title content="dify学习笔记"><meta property="og:title" content="dify学习笔记"><meta property="twitter:title" content="dify学习笔记"><meta name=description content="dify学习笔记"><meta property="og:description" content="dify学习笔记"><meta property="twitter:description" content="dify学习笔记"><meta property="twitter:card" content="summary"><meta name=keyword content="iceyao, IceYao's Blog, 博客, 个人网站, 互联网, Web, 云原生, PaaS, Istio, Kubernetes, 微服务, Microservice"><link rel="shortcut icon" href=/img/favicon.ico><title>dify学习笔记 | 爱折腾的工程师 | IceYao's Blog</title>
<link rel=canonical href=/2024/08/26/dify-readnotes/><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/hugo-theme-cleanwhite.min.css><link rel=stylesheet href=/css/zanshang.css><link rel=stylesheet href=/css/font-awesome.all.min.css><script src=/js/jquery.min.js></script><script src=/js/bootstrap.min.js></script><script src=/js/hux-blog.min.js></script><script src=/js/lazysizes.min.js></script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-9J7CKFVPPM"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-9J7CKFVPPM")}</script><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=/>爱折腾的工程师</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/>All Posts</a></li><li><a href=/archive//>ARCHIVE</a></li><li><a href=/notes//>NOTES</a></li><li><a href=/about//>ABOUT</a></li><li><a href=/search><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");$toggle.addEventListener("click",handleMagic);function handleMagic(){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}</script><style type=text/css>header.intro-header{background-image:url(/img/post-bg-unix-linux.jpg)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/llm title=LLM>LLM</a></div><h1>dify学习笔记</h1><h2 class=subheading></h2><span class=meta>Posted by
iceyao
on
Monday, August 26, 2024</span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><h1 id=1-dify简介>1. dify简介</h1><p>Dify是一个开源的LLM应用开发平台。其直观的界面结合了AI工作流、RAG管道、Agent、模型管理、可观测性功能等，让您可以快速从原型到生产。</p><h1 id=2-dify核心功能>2. dify核心功能：</h1><h2 id=21-强大的ai工作流构建与测试>2.1. 强大的AI工作流构建与测试</h2><ul><li>用户可以直观地设计和构建 AI 工作流，根据不同的业务需求和场景进行定制化操作。</li><li>能够对构建的工作流进行全面测试，确保其在实际应用中的稳定性和准确性。</li></ul><h2 id=22-全面的模型支持>2.2. 全面的模型支持</h2><ul><li>无缝集成了数百种来自数十个推理提供商和自托管解决方案的专有 / 开源大型语言模型（LLM）。</li><li>涵盖了多种不同类型的模型，为用户提供了丰富的选择，以满足不同的任务需求。</li></ul><h2 id=23-便捷的提示-ide>2.3. 便捷的提示 IDE</h2><ul><li>提供了一个集成开发环境（IDE），方便用户编写和优化提示（prompt）。</li><li>帮助用户更好地与语言模型进行交互，提高提示的质量和效果。</li></ul><h2 id=24-强大的-rag检索增强生成管道>2.4. 强大的 RAG（检索增强生成）管道</h2><ul><li>具备高效的检索增强生成功能，能够从大量的文本数据中检索相关信息，并结合语言模型生成更加准确和丰富的内容。</li><li>提升了语言模型的输出质量和实用性。</li></ul><h2 id=25-灵活的代理能力>2.5. 灵活的代理能力</h2><ul><li>允许用户设置代理，以满足不同的网络环境和访问需求。</li><li>增强了系统的灵活性和可扩展性。</li></ul><h2 id=26-有效的llmops>2.6. 有效的LLMOps</h2><ul><li>提供了一系列针对语言模型的操作和管理工具，包括模型部署、监控、优化等。</li><li>帮助用户更好地管理和维护语言模型的运行，提高工作效率。</li></ul><h2 id=27-后端即服务>2.7. 后端即服务</h2><ul><li>可以作为后端服务提供给其他应用程序使用，方便集成和扩展。</li><li>为开发者提供了便捷的接口和工具，降低了开发成本和难度。</li></ul><p>与LangChain、Flowise、OpenAI Assistant API对比：</p><table><thead><tr><th style=text-align:center>功能</th><th style=text-align:center>Dify.AI</th><th style=text-align:center>LangChain</th><th style=text-align:center>Flowise</th><th style=text-align:center>OpenAI Assistant API</th></tr></thead><tbody><tr><td style=text-align:center>编程方法</td><td style=text-align:center>API + 应用程序导向</td><td style=text-align:center>Python 代码</td><td style=text-align:center>应用程序导向</td><td style=text-align:center>API 导向</td></tr><tr><td style=text-align:center>支持的 LLMs</td><td style=text-align:center>丰富多样</td><td style=text-align:center>丰富多样</td><td style=text-align:center>丰富多样</td><td style=text-align:center>仅限 OpenAI</td></tr><tr><td style=text-align:center>RAG引擎</td><td style=text-align:center>✅</td><td style=text-align:center>✅</td><td style=text-align:center>✅</td><td style=text-align:center>✅</td></tr><tr><td style=text-align:center>Agent</td><td style=text-align:center>✅</td><td style=text-align:center>✅</td><td style=text-align:center>❌</td><td style=text-align:center>✅</td></tr><tr><td style=text-align:center>工作流</td><td style=text-align:center>✅</td><td style=text-align:center>❌</td><td style=text-align:center>✅</td><td style=text-align:center>❌</td></tr><tr><td style=text-align:center>可观测性</td><td style=text-align:center>✅</td><td style=text-align:center>✅</td><td style=text-align:center>❌</td><td style=text-align:center>❌</td></tr><tr><td style=text-align:center>企业功能（SSO/访问控制）</td><td style=text-align:center>✅</td><td style=text-align:center>❌</td><td style=text-align:center>❌</td><td style=text-align:center>❌</td></tr><tr><td style=text-align:center>本地部署</td><td style=text-align:center>✅</td><td style=text-align:center>✅</td><td style=text-align:center>✅</td><td style=text-align:center>❌</td></tr></tbody></table><h1 id=3-源码部署>3. 源码部署</h1><p>通过源码部署，方便后续代码调试，了解具体实现原理</p><ol><li>克隆dify源码</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://github.com/langgenius/dify.git
</span></span></code></pre></div><ol start=2><li>docker-compose部署外部依赖PostgresSQL/Redis/Weaviate等</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>cd</span> dify/docker
</span></span><span style=display:flex><span>cp middleware.env.example middleware.env
</span></span><span style=display:flex><span>docker compose -f docker-compose.middleware.yaml up -d
</span></span></code></pre></div><ol start=3><li>准备dify虚拟环境</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>conda create --name dify <span style=color:#8be9fd;font-style:italic>python</span><span style=color:#ff79c6>=</span>3.10
</span></span><span style=display:flex><span>conda activate dify
</span></span><span style=display:flex><span>pip install poetry
</span></span></code></pre></div><ol start=4><li>启动dify-api/dify-worker服务</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#6272a4># 进入api目录</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>cd</span> api/
</span></span><span style=display:flex><span><span style=color:#6272a4># 拷贝环境变量文件</span>
</span></span><span style=display:flex><span>cp .env.example .env
</span></span><span style=display:flex><span><span style=color:#6272a4># 生成随机密钥</span>
</span></span><span style=display:flex><span>openssl rand -base64 <span style=color:#bd93f9>42</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># 替换环境变量文件中的密钥</span>
</span></span><span style=display:flex><span>sed -i <span style=color:#f1fa8c>&#39;s/SECRET_KEY=.*/SECRET_KEY=&lt;your_value&gt;/&#39;</span> .env
</span></span><span style=display:flex><span><span style=color:#6272a4># 使用poetry安装依赖</span>
</span></span><span style=display:flex><span>poetry install
</span></span><span style=display:flex><span><span style=color:#6272a4># 执行数据库迁移到最新版本</span>
</span></span><span style=display:flex><span>flask db upgrade
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># 启动dify-api服务 </span>
</span></span><span style=display:flex><span>flask run --host 0.0.0.0 --port<span style=color:#ff79c6>=</span><span style=color:#bd93f9>5001</span> --debug
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># 启动dify-worker服务</span>
</span></span><span style=display:flex><span>celery -A app.celery worker -P gevent -c <span style=color:#bd93f9>1</span> --loglevel INFO -Q dataset,generation,mail,ops_trace
</span></span></code></pre></div><ol start=6><li>启动dify-web服务</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>cd</span> web
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># 安装依赖</span>
</span></span><span style=display:flex><span>npm install
</span></span><span style=display:flex><span><span style=color:#6272a4># 拷贝环境变量文件</span>
</span></span><span style=display:flex><span>cp .env.example .env.local
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># 编译</span>
</span></span><span style=display:flex><span>npm run build
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># 启动前端服务</span>
</span></span><span style=display:flex><span>npm run start
</span></span></code></pre></div><p>附上一个vscode launch.json文件：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&#34;version&#34;</span>: <span style=color:#f1fa8c>&#34;0.2.0&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&#34;configurations&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#34;name&#34;</span>: <span style=color:#f1fa8c>&#34;dify-api&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#34;type&#34;</span>: <span style=color:#f1fa8c>&#34;debugpy&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#34;request&#34;</span>: <span style=color:#f1fa8c>&#34;launch&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#34;module&#34;</span>: <span style=color:#f1fa8c>&#34;flask&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#34;env&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>&#34;FLASK_APP&#34;</span>: <span style=color:#f1fa8c>&#34;app.py&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>&#34;FLASK_ENV&#34;</span>: <span style=color:#f1fa8c>&#34;development&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>&#34;GEVENT_SUPPORT&#34;</span>: <span style=color:#f1fa8c>&#34;true&#34;</span>,
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#34;args&#34;</span>: [
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;run&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;--host=0.0.0.0&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;--port=5001&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;--debug&#34;</span>
</span></span><span style=display:flex><span>            ],
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#34;cwd&#34;</span>: <span style=color:#f1fa8c>&#34;${workspaceFolder}/api&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#34;justMyCode&#34;</span>: <span style=color:#ff79c6>false</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#34;name&#34;</span>: <span style=color:#f1fa8c>&#34;dify-worker&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#34;type&#34;</span>: <span style=color:#f1fa8c>&#34;debugpy&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#34;request&#34;</span>: <span style=color:#f1fa8c>&#34;launch&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#34;program&#34;</span>: <span style=color:#f1fa8c>&#34;/opt/anaconda3/envs/dify/bin/celery&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#34;env&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>&#34;GEVENT_SUPPORT&#34;</span>: <span style=color:#f1fa8c>&#34;true&#34;</span>,
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#34;args&#34;</span>: [
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;-A&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;app.celery&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;worker&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;-P&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;gevent&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;-c&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;1&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;--loglevel=INFO&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;-Q&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;dataset,generation,mail,ops_trace&#34;</span>
</span></span><span style=display:flex><span>            ],
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#34;cwd&#34;</span>: <span style=color:#f1fa8c>&#34;${workspaceFolder}/api&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#34;justMyCode&#34;</span>: <span style=color:#ff79c6>false</span>,
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#34;console&#34;</span>: <span style=color:#f1fa8c>&#34;integratedTerminal&#34;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#34;name&#34;</span>: <span style=color:#f1fa8c>&#34;dify-web&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#34;type&#34;</span>: <span style=color:#f1fa8c>&#34;node&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#34;request&#34;</span>: <span style=color:#f1fa8c>&#34;launch&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#34;runtimeExecutable&#34;</span>: <span style=color:#f1fa8c>&#34;/opt/homebrew/bin/pnpm&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#34;runtimeArgs&#34;</span>: [
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;start&#34;</span>
</span></span><span style=display:flex><span>            ],
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#34;cwd&#34;</span>: <span style=color:#f1fa8c>&#34;${workspaceFolder}/web&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#34;console&#34;</span>: <span style=color:#f1fa8c>&#34;integratedTerminal&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#34;internalConsoleOptions&#34;</span>: <span style=color:#f1fa8c>&#34;neverOpen&#34;</span>,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>如果源码编译dify-web失败的话，可以使用docker容器启动dify-web</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -it -d -p 3000:3000 -e <span style=color:#8be9fd;font-style:italic>CONSOLE_URL</span><span style=color:#ff79c6>=</span>http://127.0.0.1:5001 -e <span style=color:#8be9fd;font-style:italic>APP_URL</span><span style=color:#ff79c6>=</span>http://127.0.0.1:5001 langgenius/dify-web:latest
</span></span></code></pre></div><h1 id=源码分析>源码分析</h1><h2 id=dify-api>dify-api</h2><p>api基于flask框架实现</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>app <span style=color:#ff79c6>=</span> create_app()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>create_app</span>() <span style=color:#ff79c6>-&gt;</span> Flask:
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    创建并配置Flask应用实例。
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    该函数负责初始化一个Flask应用，设置其密钥，配置日志处理，以及注册各种扩展、蓝本和命令。
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    Returns:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        Flask: 配置好的Flask应用实例。
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># 初始化Flask应用并应用配置</span>
</span></span><span style=display:flex><span>    app <span style=color:#ff79c6>=</span> create_flask_app_with_configs()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># 设置Flask应用的secret_key，这对于会话管理是必要的</span>
</span></span><span style=display:flex><span>    app<span style=color:#ff79c6>.</span>secret_key <span style=color:#ff79c6>=</span> app<span style=color:#ff79c6>.</span>config[<span style=color:#f1fa8c>&#34;SECRET_KEY&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># 默认情况下没有日志处理器</span>
</span></span><span style=display:flex><span>    log_handlers <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># 从配置中获取日志文件路径</span>
</span></span><span style=display:flex><span>    log_file <span style=color:#ff79c6>=</span> app<span style=color:#ff79c6>.</span>config<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>&#34;LOG_FILE&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> log_file:
</span></span><span style=display:flex><span>        <span style=color:#6272a4># 确保日志文件的目录存在，如果不存在则创建</span>
</span></span><span style=display:flex><span>        log_dir <span style=color:#ff79c6>=</span> os<span style=color:#ff79c6>.</span>path<span style=color:#ff79c6>.</span>dirname(log_file)
</span></span><span style=display:flex><span>        os<span style=color:#ff79c6>.</span>makedirs(log_dir, exist_ok<span style=color:#ff79c6>=</span><span style=color:#ff79c6>True</span>)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#6272a4># 配置日志处理器，包括文件日志和控制台日志</span>
</span></span><span style=display:flex><span>        log_handlers <span style=color:#ff79c6>=</span> [
</span></span><span style=display:flex><span>            RotatingFileHandler(
</span></span><span style=display:flex><span>                filename<span style=color:#ff79c6>=</span>log_file,
</span></span><span style=display:flex><span>                maxBytes<span style=color:#ff79c6>=</span><span style=color:#bd93f9>1024</span> <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>1024</span> <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>1024</span>,  <span style=color:#6272a4># 1GB</span>
</span></span><span style=display:flex><span>                backupCount<span style=color:#ff79c6>=</span><span style=color:#bd93f9>5</span>,  <span style=color:#6272a4># 保留5个备份文件</span>
</span></span><span style=display:flex><span>            ),
</span></span><span style=display:flex><span>            logging<span style=color:#ff79c6>.</span>StreamHandler(sys<span style=color:#ff79c6>.</span>stdout),  <span style=color:#6272a4># 将日志输出到控制台</span>
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># 配置基本的日志记录设置</span>
</span></span><span style=display:flex><span>    logging<span style=color:#ff79c6>.</span>basicConfig(
</span></span><span style=display:flex><span>        level<span style=color:#ff79c6>=</span>app<span style=color:#ff79c6>.</span>config<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>&#34;LOG_LEVEL&#34;</span>),  <span style=color:#6272a4># 日志级别</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>format</span><span style=color:#ff79c6>=</span>app<span style=color:#ff79c6>.</span>config<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>&#34;LOG_FORMAT&#34;</span>),  <span style=color:#6272a4># 日志格式</span>
</span></span><span style=display:flex><span>        datefmt<span style=color:#ff79c6>=</span>app<span style=color:#ff79c6>.</span>config<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>&#34;LOG_DATEFORMAT&#34;</span>),  <span style=color:#6272a4># 日期格式</span>
</span></span><span style=display:flex><span>        handlers<span style=color:#ff79c6>=</span>log_handlers,  <span style=color:#6272a4># 使用之前配置的日志处理器</span>
</span></span><span style=display:flex><span>        force<span style=color:#ff79c6>=</span><span style=color:#ff79c6>True</span>,  <span style=color:#6272a4># 强制重新配置日志设置，以确保上述配置生效</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># 如果配置中指定了日志时区，则进行时区配置</span>
</span></span><span style=display:flex><span>    log_tz <span style=color:#ff79c6>=</span> app<span style=color:#ff79c6>.</span>config<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>&#34;LOG_TZ&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> log_tz:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>from</span> datetime <span style=color:#ff79c6>import</span> datetime
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>import</span> pytz
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># 创建时区对象</span>
</span></span><span style=display:flex><span>        timezone <span style=color:#ff79c6>=</span> pytz<span style=color:#ff79c6>.</span>timezone(log_tz)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># 定义将UTC时间转换为指定时区时间的函数</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>time_converter</span>(seconds):
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> datetime<span style=color:#ff79c6>.</span>utcfromtimestamp(seconds)<span style=color:#ff79c6>.</span>astimezone(timezone)<span style=color:#ff79c6>.</span>timetuple()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># 将所有根记录器的处理器的格式化器的时间转换函数设置为上面定义的函数</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>for</span> handler <span style=color:#ff79c6>in</span> logging<span style=color:#ff79c6>.</span>root<span style=color:#ff79c6>.</span>handlers:
</span></span><span style=display:flex><span>            handler<span style=color:#ff79c6>.</span>formatter<span style=color:#ff79c6>.</span>converter <span style=color:#ff79c6>=</span> time_converter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># 初始化应用所需的扩展</span>
</span></span><span style=display:flex><span>    initialize_extensions(app)
</span></span><span style=display:flex><span>    <span style=color:#6272a4># 注册蓝本，蓝本是Flask中组织路由的一种方式</span>
</span></span><span style=display:flex><span>    register_blueprints(app)
</span></span><span style=display:flex><span>    <span style=color:#6272a4># 注册命令行命令</span>
</span></span><span style=display:flex><span>    register_commands(app)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># 返回配置好的应用实例</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> app
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff79c6>if</span> __name__ <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    <span style=color:#6272a4># 当作为主程序运行时，启动Flask应用程序</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># 通过指定host为&#34;0.0.0.0&#34;，允许网络中的其他设备访问该服务</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># 端口号设置为5001，与其他设备通信时使用此端口</span>
</span></span><span style=display:flex><span>    app<span style=color:#ff79c6>.</span>run(host<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;0.0.0.0&#34;</span>, port<span style=color:#ff79c6>=</span><span style=color:#bd93f9>5001</span>)
</span></span></code></pre></div><h2 id=dify-worker>dify-worker</h2><h2 id=如何添加一个内置工具>如何添加一个内置工具</h2><ul><li>代码参考实现：<a href=https://github.com/langgenius/dify/pull/7991>https://github.com/langgenius/dify/pull/7991</a></li><li>官方指引：<a href=https://docs.dify.ai/guides/tools/quick-tool-integration>https://docs.dify.ai/guides/tools/quick-tool-integration</a></li></ul><h2 id=如何添加一个对象存储实现>如何添加一个对象存储实现</h2><p>代码参考实现：<a href=https://github.com/langgenius/dify/pull/8164>https://github.com/langgenius/dify/pull/8164</a></p><h2 id=如何添加一个向量数据库>如何添加一个向量数据库</h2><p>代码参考实现：<a href=https://github.com/langgenius/dify/pull/9287>https://github.com/langgenius/dify/pull/9287</a></p><h2 id=如何添加一个llm-model-provider>如何添加一个LLM Model Provider</h2><ul><li>代码参考实现：<a href=https://github.com/langgenius/dify/pull/8428>https://github.com/langgenius/dify/pull/8428</a></li><li>官方指引：<a href=https://docs.dify.ai/guides/model-configuration/new-provider>https://docs.dify.ai/guides/model-configuration/new-provider</a></li></ul><h2 id=如何添加一个embedding-model-provider>如何添加一个Embedding Model Provider</h2><ul><li>代码参考实现：<a href=https://github.com/langgenius/dify/pull/8728>https://github.com/langgenius/dify/pull/8728</a></li><li>官方指引：<a href=https://docs.dify.ai/guides/model-configuration/predefined-model>https://docs.dify.ai/guides/model-configuration/predefined-model</a></li></ul><h1 id=参考链接>参考链接</h1><ul><li><a href=https://github.com/langgenius/dify/blob/main/README_CN.md>https://github.com/langgenius/dify/blob/main/README_CN.md</a></li><li><a href=https://docs.dify.ai/getting-started/install-self-hosted/local-source-code#access-dify>如何在本地源码启动dify</a></li></ul><div class="entry-shang text-center"><p>「真诚赞赏，手留余香」</p><button class="zs show-zs btn btn-bred">赞赏支持</button></div><div class=zs-modal-bg></div><div class=zs-modal-box><div class=zs-modal-head><button type=button class=close>×</button>
<span class=author><a href=https://www.iceyao.com.cn/><img src=/img/favicon.png>爱折腾的工程师</a></span><p class=tip><i></i><span>真诚赞赏，手留余香</span></p></div><div class=zs-modal-body><div class=zs-modal-btns><button class="btn btn-blink" data-num=2>2元</button>
<button class="btn btn-blink" data-num=5>5元</button>
<button class="btn btn-blink" data-num=10>10元</button>
<button class="btn btn-blink" data-num=50>50元</button>
<button class="btn btn-blink" data-num=100>100元</button>
<button class="btn btn-blink" data-num=1>任意金额</button></div><div class=zs-modal-pay><button class="btn btn-bred" id=pay-text>2元</button><p>使用<span id=pay-type>微信</span>扫描二维码完成支付</p><img src=/img/reward/wechat-2.png id=pay-image></div></div><div class=zs-modal-footer><label><input type=radio name=zs-type value=wechat class=zs-type checked><span><span class=zs-wechat><img src=/img/reward/wechat-btn.png></span></label>
<label><input type=radio name=zs-type value=alipay class=zs-type class=zs-alipay><img src=/img/reward/alipay-btn.png></span></label></div></div><script type=text/javascript src=/js/reward.js></script><hr><ul class=pager><li class=previous><a href=/2024/08/08/dify-sandbox-readnotes/ data-toggle=tooltip data-placement=top title=dify-sandbox学习笔记>&larr;
Previous Post</a></li></ul><script src=https://giscus.app/client.js data-repo=yaoice/yaoice.github.io data-repo-id=R_kgDOJnxqVg data-category=General data-category-id=DIC_kwDOJnxqVs4CWwUs data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=0 data-theme=light data-lang=en crossorigin=anonymous async></script></div><div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container"><div class=side-catalog><hr class="hidden-sm hidden-xs"><h5><a class=catalog-toggle href=#>CATALOG</a></h5><ul class=catalog-body></ul></div></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"><section><hr class="hidden-sm hidden-xs"><h5><a href=/tags/>FEATURED TAGS</a></h5><div class=tags><a href=/tags/devops title=devops>devops
</a><a href=/tags/go title=go>go
</a><a href=/tags/k8s title=k8s>k8s
</a><a href=/tags/llm title=llm>llm
</a><a href=/tags/openstack title=openstack>openstack
</a><a href=/tags/tkestack title=tkestack>tkestack
</a><a href=/tags/%E7%BB%83%E8%BD%A6 title=练车>练车</a></div></section></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=mailto:yao3690093@gmail.com><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=/img/wechat.jpeg><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-weixin fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/yaoice><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href rel=alternate type=application/rss+xml title=爱折腾的工程师><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; 爱折腾的工程师 2024</p></div></div></div></footer><script>function loadAsync(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(null,e)},!1),i.parentNode.insertBefore(n,i)}</script><script>$("#tag_cloud").length!==0&&loadAsync("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js",function(){var e=document.querySelector("nav");e&&FastClick.attach(e)})</script><script>(function(){var t,e=document.createElement("script"),n=window.location.protocol.split(":")[0];n==="https"?e.src="https://zz.bdstatic.com/linksubmit/push.js":e.src="http://push.zhanzhang.baidu.com/push.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script><script>var _baId="92c175994ded75a3cd2074bc1123e2be",_hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="//hm.baidu.com/hm.js?"+_baId,e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,a=$(_containerSelector),r=a.find("h1,h2,h3,h4,h5,h6");return $(e).html(""),r.each(function(){t=$(this).prop("tagName").toLowerCase(),o="#"+$(this).prop("id"),n=$(this).text(),i=$('<a href="'+o+'" rel="nofollow">'+n+"</a>"),s=$('<li class="'+t+'_nav"></li>').append(i),$(e).append(s)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),loadAsync("/js/jquery.nav.js",function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script></body></html>