<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    

    
    <meta property="og:site_name" content="爱折腾的工程师">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://www.iceyao.com.cn//img/post-bg-unix-linux.jpg">
    <meta property="twitter:image" content="https://www.iceyao.com.cn//img/post-bg-unix-linux.jpg" />
    

    
    <meta name="title" content="MCP学习笔记" />
    <meta property="og:title" content="MCP学习笔记" />
    <meta property="twitter:title" content="MCP学习笔记" />
    

    
    <meta name="description" content="MCP学习笔记">
    <meta property="og:description" content="MCP学习笔记" />
    <meta property="twitter:description" content="MCP学习笔记" />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="iceyao, IceYao&#39;s Blog, 博客, 个人网站, 互联网, Web, 云原生, PaaS, Istio, Kubernetes, 微服务, Microservice">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>MCP学习笔记 | 爱折腾的工程师 | IceYao&#39;s Blog</title>

    <link rel="canonical" href="/2025/04/14/mcp-readnotes/">

    

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hugo-theme-cleanwhite.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css">

    
    

    
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>

    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    <script src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script>

    
    

</head>



  
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-9J7CKFVPPM"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-9J7CKFVPPM');
        }
      </script>
    
  







<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">爱折腾的工程师</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">All Posts</a>
                    </li>
                    
                        
                    
                    
		    
                        <li><a href="/archive//">ARCHIVE</a></li>
                    
                        <li><a href="/notes//">NOTES</a></li>
                    
                        <li><a href="/about//">ABOUT</a></li>
                    
		            <li>
                        <a href="/search"><i class="fa fa-search"></i></a>
		           </li>
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/img/post-bg-unix-linux.jpg')
    }
</style>

<header class="intro-header" >

    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/llm" title="LLM">
                            LLM
                        </a>
                        
                    </div>
                    <h1>MCP学习笔记</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        
                            Posted by 
                            
                                iceyao
                             
                            on 
                            Monday, April 14, 2025
                            
                            
                            
                            
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                
                <h1 id="1-什么是mcp">1. 什么是MCP</h1>
<p>MCP是一个开放协议，用于标准化应用程序向大语言模型提供上下文的方式。可以将MCP想象成AI应用程序的 USB-C接口。就像USB-C为设备连接各种外设和配件提供了标准化方式一样，MCP为AI模型连接不同的数据源和工具提供了标准化方式。</p>
<h1 id="2-为什么要有mcp">2. 为什么要有MCP</h1>
<p>MCP提供了连接AI模型与不同数据源和工具的标准方式。具体来说，MCP的存在意义在于：</p>
<ul>
<li>提供预构建集成 - 为LLM提供一系列可直接使用的集成组件</li>
<li>灵活切换LLM提供商 - 允许在不同的LLM供应商和厂商之间切换</li>
<li>数据安全保障 - 在您的基础设施内保护数据的最佳实践</li>
</ul>
<h1 id="2-mcp架构">2. MCP架构</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>    +---------------------------------------------------------------+
</span></span><span style="display:flex;"><span>    |                                                               |
</span></span><span style="display:flex;"><span>    | +-------------+     +-------------+       +----------------+  |
</span></span><span style="display:flex;"><span>    +---------------------------------------------------------------+
</span></span><span style="display:flex;"><span>    |                         Your Computer                         |
</span></span><span style="display:flex;"><span>    |                                                               |
</span></span><span style="display:flex;"><span>    |                    +-------------+         +----------------+ |
</span></span><span style="display:flex;"><span>    |  +----------+      |             |&lt;-------&gt;|                | |
</span></span><span style="display:flex;"><span>    |  |          |&lt;----&gt;| MCP Server A|         | Local          | |
</span></span><span style="display:flex;"><span>    |  |          |      |             |         | Data Source A  | |
</span></span><span style="display:flex;"><span>    |  |          |      +-------------+         +----------------+ |
</span></span><span style="display:flex;"><span>    |  |          |                                                 |
</span></span><span style="display:flex;"><span>    |  | Host with|                                                 |
</span></span><span style="display:flex;"><span>    |  | MCP      |      +-------------+         +----------------+ |
</span></span><span style="display:flex;"><span>    |  | Client   |&lt;----&gt;|             |&lt;-------&gt;|                | |
</span></span><span style="display:flex;"><span>    |  | (Claude, |      | MCP Server B|         | Local          | |
</span></span><span style="display:flex;"><span>    |  | IDEs,    |      |             |         | Data Source B  | |
</span></span><span style="display:flex;"><span>    |  | Tools)   |      +-------------+         +----------------+ |
</span></span><span style="display:flex;"><span>    |  |          |                                                 |
</span></span><span style="display:flex;"><span>    |  |          |      +-------------+                            |
</span></span><span style="display:flex;"><span>    |  |          |&lt;----&gt;|             |         +----------------+ |
</span></span><span style="display:flex;"><span>    |  +----------+      | MCP Server C|&lt;-------&gt;|                | |
</span></span><span style="display:flex;"><span>    |                    |             |  Web    | Remote         | |
</span></span><span style="display:flex;"><span>    |                    +-------------+  APIs   | Service C      | |
</span></span><span style="display:flex;"><span>    |                                            |                | |
</span></span><span style="display:flex;"><span>    +---------------------------------------------------------------+
</span></span><span style="display:flex;"><span>                                                |                |
</span></span><span style="display:flex;"><span>                                                +----------------+
</span></span><span style="display:flex;"><span>                                                    Internet
</span></span></code></pre></div><p>MCP遵循客户端-服务器架构，其中主机应用程序可以连接到多个服务器：</p>
<ul>
<li>MCP Hosts：如Claude Desktop、IDE或AI工具等需要通过MCP访问数据的程序</li>
<li>MCP Clients：维护与服务器1:1连接的协议客户端</li>
<li>MCP Servers：通过标准化的模型上下文协议暴露特定功能的轻量级程序</li>
<li>Local Data Sources：MCP服务器可以安全访问的计算机文件、数据库和服务</li>
<li>Remote Services：MCP服务器可以连接的互联网上的外部系统(如通过API)</li>
</ul>
<h2 id="21-mcp与llm关系">2.1 MCP与LLM关系</h2>
<p>LLM无MCP：</p>
<pre tabindex="0"><code class="language-mermaid" data-lang="mermaid">graph TD
    subgraph &#34;AI工具&#34;
        Cursor[&#34;Cursor&#34;]
        Claude[&#34;Claude Desktop&#34;]
        Windsurf[&#34;Windsurf&#34;]
    end
    
    subgraph &#34;工具调用&#34;
        Slack[&#34;Slack&#34;]
        PostgreSQL[&#34;PostgreSQL&#34;]
        GoogleDrive[&#34;Google Drive&#34;]
        Github[&#34;Github&#34;]
    end
    
    Cursor --&gt; Slack
    Cursor --&gt; PostgreSQL
    Cursor --&gt; GoogleDrive
    Cursor --&gt; Github
    
    Claude --&gt; Slack
    Claude --&gt; PostgreSQL
    Claude --&gt; GoogleDrive
    Claude --&gt; Github
    
    Windsurf --&gt; Slack
    Windsurf --&gt; PostgreSQL
    Windsurf --&gt; GoogleDrive
    Windsurf --&gt; Github
    
    style Cursor fill:#f9f,stroke:#333,stroke-width:2px
    style Claude fill:#bbf,stroke:#333,stroke-width:2px
    style Windsurf fill:#bfb,stroke:#333,stroke-width:2px
</code></pre><p>LLM有MCP：</p>
<pre tabindex="0"><code class="language-mermaid" data-lang="mermaid">graph TD
    subgraph &#34;AI工具&#34;
        Cursor[&#34;Cursor&#34;]
        Claude[&#34;Claude Desktop&#34;]
        Windsurf[&#34;Windsurf&#34;]
    end
    
    MCP[&#34;MCP协议&#34;]
    
    subgraph &#34;工具调用&#34;
        Slack[&#34;Slack&#34;]
        PostgreSQL[&#34;PostgreSQL&#34;]
        GoogleDrive[&#34;Google Drive&#34;]
        Github[&#34;Github&#34;]
    end
    
    Cursor --&gt; MCP
    Claude --&gt; MCP
    Windsurf --&gt; MCP
    
    MCP --&gt; Slack
    MCP --&gt; PostgreSQL
    MCP --&gt; GoogleDrive
    MCP --&gt; Github
    
    style Cursor fill:#f9f,stroke:#333,stroke-width:2px
    style Claude fill:#bbf,stroke:#333,stroke-width:2px
    style Windsurf fill:#bfb,stroke:#333,stroke-width:2px
    style MCP fill:#fff,stroke:#333,stroke-width:4px
</code></pre><p>对比两个图区别：引入mcp，相当于把模型和工具之间抽象了一层标准出来，有了标准之后就可以快速建立起生态，生态才是真正的&quot;护城河&quot;</p>
<h2 id="22-mcp与a2a关系">2.2 MCP与A2A关系</h2>
<p>至于MCP与A2A的区别，A2A(Agent-to-Agent)是一个用于AI代理之间通信的协议框架，MCP是一个用于AI模型与不同数据源和工具之间通信的协议框架。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>    +------------------------+                      +------------------------+
</span></span><span style="display:flex;"><span>    |                        |                      |                        |
</span></span><span style="display:flex;"><span>    |        Agent           |                      |        Agent           |
</span></span><span style="display:flex;"><span>    |                        |                      |                        |
</span></span><span style="display:flex;"><span>    | +------------------+   |      A2A协议          | +------------------+   |
</span></span><span style="display:flex;"><span>    | |                  |   |  &lt;---------------&gt;   | |                  |   |
</span></span><span style="display:flex;"><span>    | |   Local Agents   |   |                      | |   Local Agents   |   |
</span></span><span style="display:flex;"><span>    | |    [o] [o] [o]   |   |                      | |    [o] [o] [o]   |   |
</span></span><span style="display:flex;"><span>    | |                  |   |                      | |                  |   |
</span></span><span style="display:flex;"><span>    | +------------------+   |                      | +------------------+   |
</span></span><span style="display:flex;"><span>    |                        |                      |                        |
</span></span><span style="display:flex;"><span>    | +------------------+   |      组              | +------------------+   |
</span></span><span style="display:flex;"><span>    | |                  |   |      织              | |                  |   |
</span></span><span style="display:flex;"><span>    | | Vertex AI        |   |      或              | |       LLM        |   |
</span></span><span style="display:flex;"><span>    | | (Gemini API, 3P) |   |      技              | |                  |   |
</span></span><span style="display:flex;"><span>    | |                  |   |      术              | |                  |   |
</span></span><span style="display:flex;"><span>    | +------------------+   |      边              | +------------------+   |
</span></span><span style="display:flex;"><span>    |                        |      界              |                        |
</span></span><span style="display:flex;"><span>    | +------------------+   |                      | +------------------+   |
</span></span><span style="display:flex;"><span>    | |                  |   |                      | |                  |   |
</span></span><span style="display:flex;"><span>    | | Agent Development|   |                      | | Agent Framework  |   |
</span></span><span style="display:flex;"><span>    | | Kit (ADK)        |   |                      | |                  |   |
</span></span><span style="display:flex;"><span>    | |                  |   |                      | |                  |   |
</span></span><span style="display:flex;"><span>    | +------------------+   |                      | +------------------+   |
</span></span><span style="display:flex;"><span>    |          ^             |                      |          ^             |
</span></span><span style="display:flex;"><span>    |          |             |                      |          |             |
</span></span><span style="display:flex;"><span>    |          v             |                      |          v             |
</span></span><span style="display:flex;"><span>    |     +---------+        |                      |     +---------+        |
</span></span><span style="display:flex;"><span>    |     |   MCP   |        |                      |     |   MCP   |        |
</span></span><span style="display:flex;"><span>    |     +---------+        |                      |     +---------+        |
</span></span><span style="display:flex;"><span>    |          ^             |                      |          ^             |
</span></span><span style="display:flex;"><span>    |          |             |                      |          |             |
</span></span><span style="display:flex;"><span>    |          v             |                      |          v             |
</span></span><span style="display:flex;"><span>    | +------------------+   |                      | +------------------+   |
</span></span><span style="display:flex;"><span>    | |                  |   |                      | |                  |   |
</span></span><span style="display:flex;"><span>    | | APIs &amp; Enterprise|   |                      | | APIs &amp; Enterprise|   |
</span></span><span style="display:flex;"><span>    | | Applications     |   |                      | | Applications     |   |
</span></span><span style="display:flex;"><span>    | |                  |   |                      | |                  |   |
</span></span><span style="display:flex;"><span>    | +------------------+   |                      | +------------------+   |
</span></span><span style="display:flex;"><span>    |                        |                      |                        |
</span></span><span style="display:flex;"><span>    +------------------------+                      +------------------------+
</span></span></code></pre></div><h2 id="23-mcp通信方式">2.3 MCP通信方式</h2>
<p>MCP Client与MCP Server之间的通信方式：</p>
<ul>
<li>Stdio方式：通过标准输入和输出流进行通信（适合本地程序）
<pre tabindex="0"><code class="language-mermaid" data-lang="mermaid">  sequenceDiagram
  participant Client
  participant Server as Server Process

  Client-&gt;&gt;Server: Launch subprocess

  rect rgb(240, 240, 240)
  note over Client,Server: Message Exchange

  loop 消息交换
      Client-&gt;&gt;Server: Write to stdin
      Server-&gt;&gt;Client: Write to stdout
      Server--&gt;&gt;Client: Optional logs on stderr
  end
  end

  Client-&gt;&gt;Server: Close stdin, terminate subprocess
</code></pre></li>
<li>Streamable HTTP方式：通过HTTP协议进行通信（适合远程调用），从MCP协议版本2024-11-05开始取代<code>HTTP+SSE</code>方式，SSE成为可选实现。
<pre tabindex="0"><code class="language-mermaid" data-lang="mermaid">---
title: HTTP+SSE方式通信的流程图
---
sequenceDiagram
  participant Client
  participant Server

  Client-&gt;&gt;Server: Open SSE connection
  Server-&gt;&gt;Client: endpoint event

  rect rgb(240, 240, 240)
  note over Client,Server: [Message Exchange]

  loop
      Client-&gt;&gt;Server: HTTP POST messages
      Server-&gt;&gt;Client: SSE message events
  end
  end

  Client-&gt;&gt;Server: Close SSE connection
</code></pre></li>
</ul>
<p>MCP采用<a href="https://www.jsonrpc.org/">JSON-RPC 2.0</a>作为其通信消息的标准格式。完整的协议规范可以在<a href="https://modelcontextprotocol.io/specification">MCP官方文档</a>中找到。值得一提的是，MCP的设计理念借鉴了微软开发的<a href="https://microsoft.github.io/language-server-protocol/">Language Server Protocol (LSP)</a>。LSP作为一个成熟的协议范例，自2016年推出以来，成功地实现了IDE和编程语言工具之间的标准化通信，为开发者提供了包括代码自动补全、跳转定义、引用查找等丰富的编程辅助功能。MCP正是希望在AI领域实现类似的标准化目标。</p>
<h1 id="3-mcp开发与使用">3. MCP开发与使用</h1>
<h2 id="31-mcp-server开发">3.1 MCP Server开发</h2>
<h3 id="311-stdio方式">3.1.1 Stdio方式</h3>
<p>以python为例，开发一个获取天气的MCP Server（Tool类型），核心是通过<code>mcp.tool</code>装饰器暴露方法</p>
<ol>
<li>使用<code>uv</code>构建python环境</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -LsSf https://astral.sh/uv/install.sh | sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 初始化项目</span>
</span></span><span style="display:flex;"><span>uv init weather
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">cd</span> weather
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 创建虚拟环境</span>
</span></span><span style="display:flex;"><span>uv venv
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">source</span> .venv/bin/activate
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Remove boilerplate files</span>
</span></span><span style="display:flex;"><span>rm main.py
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 安装依赖</span>
</span></span><span style="display:flex;"><span>uv add <span style="color:#f1fa8c">&#34;mcp[cli]&#34;</span> httpx
</span></span></code></pre></div><p><code>uv</code>是当下最好用的包管理工具，基于rust语言实现，官方号称安装包的速度比传统工具快10～100倍</p>
<ol start="2">
<li>创建server文件<code>weather.py</code>，通信方式采用stdio方式</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> typing <span style="color:#ff79c6">import</span> Any
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> httpx
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> mcp.server.fastmcp <span style="color:#ff79c6">import</span> FastMCP
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Initialize FastMCP server</span>
</span></span><span style="display:flex;"><span>mcp <span style="color:#ff79c6">=</span> FastMCP(<span style="color:#f1fa8c">&#34;weather&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Constants</span>
</span></span><span style="display:flex;"><span>NWS_API_BASE <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;https://api.weather.gov&#34;</span>
</span></span><span style="display:flex;"><span>USER_AGENT <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;weather-app/1.0&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Define helper function</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">make_nws_request</span>(url: <span style="color:#8be9fd;font-style:italic">str</span>) <span style="color:#ff79c6">-&gt;</span> <span style="color:#8be9fd;font-style:italic">dict</span>[<span style="color:#8be9fd;font-style:italic">str</span>, Any] <span style="color:#ff79c6">|</span> <span style="color:#ff79c6">None</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;&#34;&#34;Make a request to the NWS API with proper error handling.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    headers <span style="color:#ff79c6">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;User-Agent&#34;</span>: USER_AGENT,
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;Accept&#34;</span>: <span style="color:#f1fa8c">&#34;application/geo+json&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> httpx<span style="color:#ff79c6">.</span>AsyncClient() <span style="color:#ff79c6">as</span> client:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>            response <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> client<span style="color:#ff79c6">.</span>get(url, headers<span style="color:#ff79c6">=</span>headers, timeout<span style="color:#ff79c6">=</span><span style="color:#bd93f9">30.0</span>)
</span></span><span style="display:flex;"><span>            response<span style="color:#ff79c6">.</span>raise_for_status()
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> response<span style="color:#ff79c6">.</span>json()
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">except</span> Exception:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">format_alert</span>(feature: <span style="color:#8be9fd;font-style:italic">dict</span>) <span style="color:#ff79c6">-&gt;</span> <span style="color:#8be9fd;font-style:italic">str</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;&#34;&#34;Format an alert feature into a readable string.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    props <span style="color:#ff79c6">=</span> feature[<span style="color:#f1fa8c">&#34;properties&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">Event: </span><span style="color:#f1fa8c">{</span>props<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;event&#39;</span>, <span style="color:#f1fa8c">&#39;Unknown&#39;</span>)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">Area: </span><span style="color:#f1fa8c">{</span>props<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;areaDesc&#39;</span>, <span style="color:#f1fa8c">&#39;Unknown&#39;</span>)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">Severity: </span><span style="color:#f1fa8c">{</span>props<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;severity&#39;</span>, <span style="color:#f1fa8c">&#39;Unknown&#39;</span>)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">Description: </span><span style="color:#f1fa8c">{</span>props<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;description&#39;</span>, <span style="color:#f1fa8c">&#39;No description available&#39;</span>)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">Instructions: </span><span style="color:#f1fa8c">{</span>props<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#39;instruction&#39;</span>, <span style="color:#f1fa8c">&#39;No specific instructions provided&#39;</span>)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 通过mcp.tool装饰器暴露方法</span>
</span></span><span style="display:flex;"><span>@mcp.tool()
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">get_alerts</span>(
</span></span><span style="display:flex;"><span>    state: <span style="color:#8be9fd;font-style:italic">str</span> <span style="color:#ff79c6">=</span> Field(description<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;Two-letter US state code (e.g. CA, NY)&#34;</span>),
</span></span><span style="display:flex;"><span>) <span style="color:#ff79c6">-&gt;</span> <span style="color:#8be9fd;font-style:italic">str</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;&#34;&#34;Get weather alerts for a US state.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        state: Two-letter US state code (e.g. CA, NY)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    url <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">{</span>NWS_API_BASE<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/alerts/active/area/</span><span style="color:#f1fa8c">{</span>state<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>    data <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> make_nws_request(url)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">not</span> data <span style="color:#ff79c6">or</span> <span style="color:#f1fa8c">&#34;features&#34;</span> <span style="color:#ff79c6">not</span> <span style="color:#ff79c6">in</span> data:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;Unable to fetch alerts or no alerts found.&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">not</span> data[<span style="color:#f1fa8c">&#34;features&#34;</span>]:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;No active alerts for this state.&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    alerts <span style="color:#ff79c6">=</span> [format_alert(feature) <span style="color:#ff79c6">for</span> feature <span style="color:#ff79c6">in</span> data[<span style="color:#f1fa8c">&#34;features&#34;</span>]]
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">---</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">.</span>join(alerts)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@mcp.tool()
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">get_forecast</span>(
</span></span><span style="display:flex;"><span>    latitude: <span style="color:#8be9fd;font-style:italic">float</span> <span style="color:#ff79c6">=</span> Field(description<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;Latitude of the location&#34;</span>),
</span></span><span style="display:flex;"><span>    longitude: <span style="color:#8be9fd;font-style:italic">float</span> <span style="color:#ff79c6">=</span> Field(description<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;Longitude of the location&#34;</span>),
</span></span><span style="display:flex;"><span>) <span style="color:#ff79c6">-&gt;</span> <span style="color:#8be9fd;font-style:italic">str</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;&#34;&#34;Get weather forecast for a location.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        latitude: Latitude of the location
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        longitude: Longitude of the location
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># First get the forecast grid endpoint</span>
</span></span><span style="display:flex;"><span>    points_url <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">{</span>NWS_API_BASE<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/points/</span><span style="color:#f1fa8c">{</span>latitude<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">,</span><span style="color:#f1fa8c">{</span>longitude<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>    points_data <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> make_nws_request(points_url)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">not</span> points_data:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;Unable to fetch forecast data for this location.&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># Get the forecast URL from the points response</span>
</span></span><span style="display:flex;"><span>    forecast_url <span style="color:#ff79c6">=</span> points_data[<span style="color:#f1fa8c">&#34;properties&#34;</span>][<span style="color:#f1fa8c">&#34;forecast&#34;</span>]
</span></span><span style="display:flex;"><span>    forecast_data <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> make_nws_request(forecast_url)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">not</span> forecast_data:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;Unable to fetch detailed forecast.&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># Format the periods into a readable forecast</span>
</span></span><span style="display:flex;"><span>    periods <span style="color:#ff79c6">=</span> forecast_data[<span style="color:#f1fa8c">&#34;properties&#34;</span>][<span style="color:#f1fa8c">&#34;periods&#34;</span>]
</span></span><span style="display:flex;"><span>    forecasts <span style="color:#ff79c6">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> period <span style="color:#ff79c6">in</span> periods[:<span style="color:#bd93f9">5</span>]:  <span style="color:#6272a4"># Only show next 5 periods</span>
</span></span><span style="display:flex;"><span>        forecast <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">{</span>period[<span style="color:#f1fa8c">&#39;name&#39;</span>]<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">Temperature: </span><span style="color:#f1fa8c">{</span>period[<span style="color:#f1fa8c">&#39;temperature&#39;</span>]<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">°</span><span style="color:#f1fa8c">{</span>period[<span style="color:#f1fa8c">&#39;temperatureUnit&#39;</span>]<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">Wind: </span><span style="color:#f1fa8c">{</span>period[<span style="color:#f1fa8c">&#39;windSpeed&#39;</span>]<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c"> </span><span style="color:#f1fa8c">{</span>period[<span style="color:#f1fa8c">&#39;windDirection&#39;</span>]<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">Forecast: </span><span style="color:#f1fa8c">{</span>period[<span style="color:#f1fa8c">&#39;detailedForecast&#39;</span>]<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        forecasts<span style="color:#ff79c6">.</span>append(forecast)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">---</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">.</span>join(forecasts)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> __name__ <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># 以stdio方式运行mcp server</span>
</span></span><span style="display:flex;"><span>    mcp<span style="color:#ff79c6">.</span>run(transport<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;stdio&#39;</span>)
</span></span></code></pre></div><p>使用<a href="https://github.com/modelcontextprotocol/python-sdk">MCP python-sdk</a>来开发 MCP Server的时候会涉及到使用<code>FastMCP</code>类或<code>Server</code>类，<code>mcp.server.lowlevel</code>中的 <code>Server</code>类与<code>FastMCP</code>类之间的区别：</p>
<ul>
<li><code>Server</code>是MCP的低级别实现，提供对协议的完全控制，但需要更多的手动配置</li>
<li><code>FastMCP</code>是构建在<code>Server</code>之上的高级接口，提供了更简洁的API和额外的功能</li>
<li>大多数开发者应该使用<code>FastMCP</code>，除非需要对MCP协议有更精细的控制</li>
<li><code>FastMCP</code>内部使用<code>Server</code>类来处理核心协议功能</li>
</ul>
<ol start="3">
<li>验证测试，这里使用vscode+cline插件当作mcp client，编辑<code>cline MCP Servers -&gt; Configure MCP Servers/cline_mcp_settings.json</code>，替换为绝对路径</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;mcpServers&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&#34;weather&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&#34;command&#34;</span>: <span style="color:#f1fa8c">&#34;uv&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&#34;args&#34;</span>: [
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;--directory&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;/ABSOLUTE/PATH/TO/PARENT/FOLDER/weather&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;run&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;weather.py&#34;</span>
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>示例：在Cline聊天对话窗口中输入获取纽约天气的指令，就会触发<code>get_forecast</code>方法</p>
<h3 id="312-streamable-http方式">3.1.2 Streamable HTTP方式</h3>
<p><code>FastMCP</code>类的run方法还未集成普通HTTP的方式，还是以<code>sse</code>方式为例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">if</span> __name__ <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># 以sse方式运行mcp server</span>
</span></span><span style="display:flex;"><span>    mcp<span style="color:#ff79c6">.</span>run(transport<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;sse&#34;</span>)
</span></span></code></pre></div><p>sse监听的地址、端口、路径等可以在初始化FastMCP实例时传入参数</p>
<p>Cline MCP Servers配置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;mcpServers&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&#34;remote-server&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&#34;url&#34;</span>: <span style="color:#f1fa8c">&#34;http://127.0.0.1:8000/sse&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&#34;alwaysAllow&#34;</span>: [<span style="color:#f1fa8c">&#34;*&#34;</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&#34;disabled&#34;</span>: <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="32-mcp-client开发">3.2 MCP Client开发</h2>
<h3 id="321-stdio方式">3.2.1 Stdio方式</h3>
<p>以python为例，实现一个上面获取天气的MCP Server交互的MCP Client</p>
<ol>
<li>uv构建python环境</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>uv init mcp-client
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">cd</span> mcp-client
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>uv venv
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">source</span> .venv/bin/activate
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Install required packages</span>
</span></span><span style="display:flex;"><span>uv add mcp anthropic python-dotenv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Remove boilerplate files</span>
</span></span><span style="display:flex;"><span>rm main.py
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Create our main file</span>
</span></span><span style="display:flex;"><span>touch client.py
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Add your key to the .env file</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#f1fa8c">&lt;&lt; EOF &gt; .env
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">OPENAI_API_KEY=&#34;sk-xxx&#34; # 替换为真正的API key
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">OPENAI_BASE_URL=&#34;https://api.deepseek.com&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">EOF</span>
</span></span></code></pre></div><ol start="2">
<li>实现client文件<code>client.py</code>，官方原有例子是调用claude模型，这里利用AI编程工具改造成使用openai sdk调用deepseek模型；OpenAI SDK原生不支持MCP，但是OpenAI Agents SDK支持MCP</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> typing <span style="color:#ff79c6">import</span> Optional
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> contextlib <span style="color:#ff79c6">import</span> AsyncExitStack
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> mcp <span style="color:#ff79c6">import</span> ClientSession, StdioServerParameters
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> mcp.client.stdio <span style="color:#ff79c6">import</span> stdio_client
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> openai <span style="color:#ff79c6">import</span> OpenAI
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> dotenv <span style="color:#ff79c6">import</span> load_dotenv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>load_dotenv()  <span style="color:#6272a4"># load environment variables from .env</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">MCPClient</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> __init__(self):
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Initialize session and client objects</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#ff79c6">.</span>session: Optional[ClientSession] <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#ff79c6">.</span>exit_stack <span style="color:#ff79c6">=</span> AsyncExitStack()
</span></span><span style="display:flex;"><span>        self<span style="color:#ff79c6">.</span>openai <span style="color:#ff79c6">=</span> OpenAI()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">connect_to_server</span>(self, server_script_path: <span style="color:#8be9fd;font-style:italic">str</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Connect to an MCP server
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        Args:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            server_script_path: Path to the server script (.py or .js)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        is_python <span style="color:#ff79c6">=</span> server_script_path<span style="color:#ff79c6">.</span>endswith(<span style="color:#f1fa8c">&#39;.py&#39;</span>)
</span></span><span style="display:flex;"><span>        is_js <span style="color:#ff79c6">=</span> server_script_path<span style="color:#ff79c6">.</span>endswith(<span style="color:#f1fa8c">&#39;.js&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">not</span> (is_python <span style="color:#ff79c6">or</span> is_js):
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">raise</span> ValueError(<span style="color:#f1fa8c">&#34;Server script must be a .py or .js file&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        command <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;python&#34;</span> <span style="color:#ff79c6">if</span> is_python <span style="color:#ff79c6">else</span> <span style="color:#f1fa8c">&#34;node&#34;</span>
</span></span><span style="display:flex;"><span>        server_params <span style="color:#ff79c6">=</span> StdioServerParameters(
</span></span><span style="display:flex;"><span>            command<span style="color:#ff79c6">=</span>command,
</span></span><span style="display:flex;"><span>            args<span style="color:#ff79c6">=</span>[server_script_path],
</span></span><span style="display:flex;"><span>            env<span style="color:#ff79c6">=</span><span style="color:#ff79c6">None</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        stdio_transport <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> self<span style="color:#ff79c6">.</span>exit_stack<span style="color:#ff79c6">.</span>enter_async_context(stdio_client(server_params))
</span></span><span style="display:flex;"><span>        self<span style="color:#ff79c6">.</span>stdio, self<span style="color:#ff79c6">.</span>write <span style="color:#ff79c6">=</span> stdio_transport
</span></span><span style="display:flex;"><span>        self<span style="color:#ff79c6">.</span>session <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> self<span style="color:#ff79c6">.</span>exit_stack<span style="color:#ff79c6">.</span>enter_async_context(ClientSession(self<span style="color:#ff79c6">.</span>stdio, self<span style="color:#ff79c6">.</span>write))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">await</span> self<span style="color:#ff79c6">.</span>session<span style="color:#ff79c6">.</span>initialize()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># List available tools</span>
</span></span><span style="display:flex;"><span>        response <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> self<span style="color:#ff79c6">.</span>session<span style="color:#ff79c6">.</span>list_tools()
</span></span><span style="display:flex;"><span>        tools <span style="color:#ff79c6">=</span> response<span style="color:#ff79c6">.</span>tools
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">已连接到服务器，可用工具：&#34;</span>, [tool<span style="color:#ff79c6">.</span>name <span style="color:#ff79c6">for</span> tool <span style="color:#ff79c6">in</span> tools])    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">process_query</span>(self, query: <span style="color:#8be9fd;font-style:italic">str</span>) <span style="color:#ff79c6">-&gt;</span> <span style="color:#8be9fd;font-style:italic">str</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Process a query using OpenAI and available tools&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        messages <span style="color:#ff79c6">=</span> [
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;role&#34;</span>: <span style="color:#f1fa8c">&#34;user&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;content&#34;</span>: query
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        response <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> self<span style="color:#ff79c6">.</span>session<span style="color:#ff79c6">.</span>list_tools()
</span></span><span style="display:flex;"><span>        available_tools <span style="color:#ff79c6">=</span> [{
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;type&#34;</span>: <span style="color:#f1fa8c">&#34;function&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;function&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;name&#34;</span>: tool<span style="color:#ff79c6">.</span>name,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;description&#34;</span>: tool<span style="color:#ff79c6">.</span>description,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;parameters&#34;</span>: tool<span style="color:#ff79c6">.</span>inputSchema
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#ff79c6">for</span> tool <span style="color:#ff79c6">in</span> response<span style="color:#ff79c6">.</span>tools]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Initial OpenAI API call</span>
</span></span><span style="display:flex;"><span>        response <span style="color:#ff79c6">=</span> self<span style="color:#ff79c6">.</span>openai<span style="color:#ff79c6">.</span>chat<span style="color:#ff79c6">.</span>completions<span style="color:#ff79c6">.</span>create(
</span></span><span style="display:flex;"><span>            model<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;deepseek-chat&#34;</span>,
</span></span><span style="display:flex;"><span>            max_tokens<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1000</span>,
</span></span><span style="display:flex;"><span>            messages<span style="color:#ff79c6">=</span>messages,
</span></span><span style="display:flex;"><span>            tools<span style="color:#ff79c6">=</span>available_tools
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Process response and handle tool calls</span>
</span></span><span style="display:flex;"><span>        final_text <span style="color:#ff79c6">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        assistant_message <span style="color:#ff79c6">=</span> response<span style="color:#ff79c6">.</span>choices[<span style="color:#bd93f9">0</span>]<span style="color:#ff79c6">.</span>message
</span></span><span style="display:flex;"><span>        assistant_message_content <span style="color:#ff79c6">=</span> assistant_message<span style="color:#ff79c6">.</span>content <span style="color:#ff79c6">or</span> <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> assistant_message_content:
</span></span><span style="display:flex;"><span>            final_text<span style="color:#ff79c6">.</span>append(assistant_message_content)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Handle tool calls if present</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> assistant_message<span style="color:#ff79c6">.</span>tool_calls:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">for</span> tool_call <span style="color:#ff79c6">in</span> assistant_message<span style="color:#ff79c6">.</span>tool_calls:
</span></span><span style="display:flex;"><span>                tool_name <span style="color:#ff79c6">=</span> tool_call<span style="color:#ff79c6">.</span>function<span style="color:#ff79c6">.</span>name
</span></span><span style="display:flex;"><span>                tool_args <span style="color:#ff79c6">=</span> tool_call<span style="color:#ff79c6">.</span>function<span style="color:#ff79c6">.</span>arguments
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4"># 将 JSON 字符串转换为字典对象</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">isinstance</span>(tool_args, <span style="color:#8be9fd;font-style:italic">str</span>):
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>                        tool_args_dict <span style="color:#ff79c6">=</span> json<span style="color:#ff79c6">.</span>loads(tool_args)
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">except</span> json<span style="color:#ff79c6">.</span>JSONDecodeError:
</span></span><span style="display:flex;"><span>                        tool_args_dict <span style="color:#ff79c6">=</span> {<span style="color:#f1fa8c">&#34;text&#34;</span>: tool_args}
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>                    tool_args_dict <span style="color:#ff79c6">=</span> tool_args
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4"># Execute tool call</span>
</span></span><span style="display:flex;"><span>                result <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> self<span style="color:#ff79c6">.</span>session<span style="color:#ff79c6">.</span>call_tool(tool_name, tool_args_dict)
</span></span><span style="display:flex;"><span>                final_text<span style="color:#ff79c6">.</span>append(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;[调用工具 </span><span style="color:#f1fa8c">{</span>tool_name<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">，参数 </span><span style="color:#f1fa8c">{</span>tool_args<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">]&#34;</span>)
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4"># Add assistant message and tool result to messages</span>
</span></span><span style="display:flex;"><span>                messages<span style="color:#ff79c6">.</span>append({
</span></span><span style="display:flex;"><span>                    <span style="color:#f1fa8c">&#34;role&#34;</span>: <span style="color:#f1fa8c">&#34;assistant&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#f1fa8c">&#34;content&#34;</span>: <span style="color:#ff79c6">None</span>,  <span style="color:#6272a4"># 设置为 None，因为我们使用 tool_calls</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f1fa8c">&#34;tool_calls&#34;</span>: [
</span></span><span style="display:flex;"><span>                        {
</span></span><span style="display:flex;"><span>                            <span style="color:#f1fa8c">&#34;id&#34;</span>: tool_call<span style="color:#ff79c6">.</span>id,
</span></span><span style="display:flex;"><span>                            <span style="color:#f1fa8c">&#34;type&#34;</span>: <span style="color:#f1fa8c">&#34;function&#34;</span>,
</span></span><span style="display:flex;"><span>                            <span style="color:#f1fa8c">&#34;function&#34;</span>: {
</span></span><span style="display:flex;"><span>                                <span style="color:#f1fa8c">&#34;name&#34;</span>: tool_name,
</span></span><span style="display:flex;"><span>                                <span style="color:#f1fa8c">&#34;arguments&#34;</span>: tool_args
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    ]
</span></span><span style="display:flex;"><span>                })
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4"># 工具结果消息必须使用字符串内容</span>
</span></span><span style="display:flex;"><span>                messages<span style="color:#ff79c6">.</span>append({
</span></span><span style="display:flex;"><span>                    <span style="color:#f1fa8c">&#34;role&#34;</span>: <span style="color:#f1fa8c">&#34;tool&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#f1fa8c">&#34;tool_call_id&#34;</span>: tool_call<span style="color:#ff79c6">.</span>id,
</span></span><span style="display:flex;"><span>                    <span style="color:#f1fa8c">&#34;content&#34;</span>: <span style="color:#8be9fd;font-style:italic">str</span>(result<span style="color:#ff79c6">.</span>content)  <span style="color:#6272a4"># 确保内容是字符串</span>
</span></span><span style="display:flex;"><span>                })
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4"># Get next response from OpenAI</span>
</span></span><span style="display:flex;"><span>                response <span style="color:#ff79c6">=</span> self<span style="color:#ff79c6">.</span>openai<span style="color:#ff79c6">.</span>chat<span style="color:#ff79c6">.</span>completions<span style="color:#ff79c6">.</span>create(
</span></span><span style="display:flex;"><span>                    model<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;deepseek-chat&#34;</span>,
</span></span><span style="display:flex;"><span>                    max_tokens<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1000</span>,
</span></span><span style="display:flex;"><span>                    messages<span style="color:#ff79c6">=</span>messages,
</span></span><span style="display:flex;"><span>                    tools<span style="color:#ff79c6">=</span>available_tools
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                next_content <span style="color:#ff79c6">=</span> response<span style="color:#ff79c6">.</span>choices[<span style="color:#bd93f9">0</span>]<span style="color:#ff79c6">.</span>message<span style="color:#ff79c6">.</span>content <span style="color:#ff79c6">or</span> <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">if</span> next_content:
</span></span><span style="display:flex;"><span>                    final_text<span style="color:#ff79c6">.</span>append(next_content)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">.</span>join(final_text)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">chat_loop</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Run an interactive chat loop&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">MCP 客户端已启动！&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;输入您的问题或输入 &#39;quit&#39; 退出。&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">True</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>                query <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">input</span>(<span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">问题: &#34;</span>)<span style="color:#ff79c6">.</span>strip()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">if</span> query<span style="color:#ff79c6">.</span>lower() <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;quit&#39;</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                response <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> self<span style="color:#ff79c6">.</span>process_query(query)
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#ff79c6">+</span> response)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">except</span> Exception <span style="color:#ff79c6">as</span> e:
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">错误: </span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">str</span>(e)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">import</span> traceback
</span></span><span style="display:flex;"><span>                traceback<span style="color:#ff79c6">.</span>print_exc()  <span style="color:#6272a4"># 打印完整的错误堆栈，帮助调试</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">cleanup</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Clean up resources&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">await</span> self<span style="color:#ff79c6">.</span>exit_stack<span style="color:#ff79c6">.</span>aclose()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">main</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">len</span>(sys<span style="color:#ff79c6">.</span>argv) <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">2</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;用法: python client.py &lt;path_to_server_script&gt;&#34;</span>)
</span></span><span style="display:flex;"><span>        sys<span style="color:#ff79c6">.</span>exit(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    client <span style="color:#ff79c6">=</span> MCPClient()
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">await</span> client<span style="color:#ff79c6">.</span>connect_to_server(sys<span style="color:#ff79c6">.</span>argv[<span style="color:#bd93f9">1</span>])
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">await</span> client<span style="color:#ff79c6">.</span>chat_loop()
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">finally</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">await</span> client<span style="color:#ff79c6">.</span>cleanup()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> __name__ <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">import</span> sys
</span></span><span style="display:flex;"><span>    asyncio<span style="color:#ff79c6">.</span>run(main())
</span></span></code></pre></div><ol start="3">
<li>终端使用uv运行mcp client和mcp server</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ff79c6">(</span>mcp-client<span style="color:#ff79c6">)</span> iceyao@macbookair mcp-client % uv run client.py ../weather/weather.py
</span></span><span style="display:flex;"><span>Processing request of <span style="color:#8be9fd;font-style:italic">type</span> ListToolsRequest
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>已连接到服务器，可用工具： <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#39;get_alerts&#39;</span>, <span style="color:#f1fa8c">&#39;get_forecast&#39;</span><span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>MCP 客户端已启动！
</span></span><span style="display:flex;"><span>输入您的问题或输入 <span style="color:#f1fa8c">&#39;quit&#39;</span> 退出。
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>问题: 获取芝加哥的天气
</span></span><span style="display:flex;"><span>Processing request of <span style="color:#8be9fd;font-style:italic">type</span> ListToolsRequest
</span></span><span style="display:flex;"><span>Processing request of <span style="color:#8be9fd;font-style:italic">type</span> CallToolRequest
</span></span><span style="display:flex;"><span>HTTP Request: GET https://api.weather.gov/points/41.8781,-87.6298 <span style="color:#f1fa8c">&#34;HTTP/1.1 200 OK&#34;</span>
</span></span><span style="display:flex;"><span>HTTP Request: GET https://api.weather.gov/gridpoints/LOT/76,73/forecast <span style="color:#f1fa8c">&#34;HTTP/1.1 200 OK&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>调用工具 get_forecast，参数 <span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;latitude&#34;</span>:41.8781,<span style="color:#f1fa8c">&#34;longitude&#34;</span>:-87.6298<span style="color:#ff79c6">}]</span>
</span></span><span style="display:flex;"><span>芝加哥的天气预报如下：
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- **今晚**：  
</span></span><span style="display:flex;"><span>  温度：42°F  
</span></span><span style="display:flex;"><span>  风速：5 mph 东北风  
</span></span><span style="display:flex;"><span>  天气：大部分晴朗，最低温度约42°F。
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- **周日**：  
</span></span><span style="display:flex;"><span>  温度：55°F  
</span></span><span style="display:flex;"><span>  风速：5-10 mph 东南风  
</span></span><span style="display:flex;"><span>  天气：大部分晴朗，最高温度约55°F，阵风可达20 mph。
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- **周日晚上**：  
</span></span><span style="display:flex;"><span>  温度：52°F  
</span></span><span style="display:flex;"><span>  风速：10 mph 东南风  
</span></span><span style="display:flex;"><span>  天气：大部分晴朗，最低温度约52°F，阵风可达20 mph。
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- **周一**：  
</span></span><span style="display:flex;"><span>  温度：79°F  
</span></span><span style="display:flex;"><span>  风速：10-20 mph 南风  
</span></span><span style="display:flex;"><span>  天气：大部分晴朗，最高温度约79°F，阵风可达35 mph。
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- **周一晚上**：  
</span></span><span style="display:flex;"><span>  温度：65°F  
</span></span><span style="display:flex;"><span>  风速：20-30 mph 西南风  
</span></span><span style="display:flex;"><span>  天气：多云，有60%的降水概率，可能有阵雨和雷暴，最低温度约65°F，阵风可达40 mph。
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>请根据天气情况合理安排出行！
</span></span></code></pre></div><h3 id="322-streamable-http方式">3.2.2 Streamable HTTP方式</h3>
<p>先启动mcp server，会监听在<code>http://0.0.0.0:8000</code>，然后设置相应的环境变量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#6272a4"># vim .env</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">OPENAI_API_KEY</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;sk-xxx&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">OPENAI_BASE_URL</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;https://api.deepseek.com&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">MCP_SERVER_SSE_URL</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;http://127.0.0.1:8000/sse&#34;</span>
</span></span></code></pre></div><p>连接mcp server sse的python client实现</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> typing <span style="color:#ff79c6">import</span> Optional
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> contextlib <span style="color:#ff79c6">import</span> AsyncExitStack
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> mcp <span style="color:#ff79c6">import</span> ClientSession
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> mcp.client.sse <span style="color:#ff79c6">import</span> sse_client
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> openai <span style="color:#ff79c6">import</span> OpenAI
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> dotenv <span style="color:#ff79c6">import</span> load_dotenv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>load_dotenv()  <span style="color:#6272a4"># load environment variables from .env</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">MCPClient</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> __init__(self):
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Initialize session and client objects</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#ff79c6">.</span>session: Optional[ClientSession] <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#ff79c6">.</span>exit_stack <span style="color:#ff79c6">=</span> AsyncExitStack()
</span></span><span style="display:flex;"><span>        self<span style="color:#ff79c6">.</span>openai <span style="color:#ff79c6">=</span> OpenAI()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">connect_to_server</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Connect to an MCP server
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        Args:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        sse_transport <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> self<span style="color:#ff79c6">.</span>exit_stack<span style="color:#ff79c6">.</span>enter_async_context(
</span></span><span style="display:flex;"><span>            sse_client(url<span style="color:#ff79c6">=</span>os<span style="color:#ff79c6">.</span>environ<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">&#34;MCP_SERVER_SSE_URL&#34;</span>))
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        self<span style="color:#ff79c6">.</span>stdio, self<span style="color:#ff79c6">.</span>write <span style="color:#ff79c6">=</span> sse_transport
</span></span><span style="display:flex;"><span>        self<span style="color:#ff79c6">.</span>session <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> self<span style="color:#ff79c6">.</span>exit_stack<span style="color:#ff79c6">.</span>enter_async_context(
</span></span><span style="display:flex;"><span>            ClientSession(self<span style="color:#ff79c6">.</span>stdio, self<span style="color:#ff79c6">.</span>write)
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">await</span> self<span style="color:#ff79c6">.</span>session<span style="color:#ff79c6">.</span>initialize()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># List available tools</span>
</span></span><span style="display:flex;"><span>        response <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> self<span style="color:#ff79c6">.</span>session<span style="color:#ff79c6">.</span>list_tools()
</span></span><span style="display:flex;"><span>        tools <span style="color:#ff79c6">=</span> response<span style="color:#ff79c6">.</span>tools
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">已连接到服务器，可用工具：&#34;</span>, [tool<span style="color:#ff79c6">.</span>name <span style="color:#ff79c6">for</span> tool <span style="color:#ff79c6">in</span> tools])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">process_query</span>(self, query: <span style="color:#8be9fd;font-style:italic">str</span>) <span style="color:#ff79c6">-&gt;</span> <span style="color:#8be9fd;font-style:italic">str</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Process a query using OpenAI and available tools&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        messages <span style="color:#ff79c6">=</span> [{<span style="color:#f1fa8c">&#34;role&#34;</span>: <span style="color:#f1fa8c">&#34;user&#34;</span>, <span style="color:#f1fa8c">&#34;content&#34;</span>: query}]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        response <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> self<span style="color:#ff79c6">.</span>session<span style="color:#ff79c6">.</span>list_tools()
</span></span><span style="display:flex;"><span>        available_tools <span style="color:#ff79c6">=</span> [
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;type&#34;</span>: <span style="color:#f1fa8c">&#34;function&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;function&#34;</span>: {
</span></span><span style="display:flex;"><span>                    <span style="color:#f1fa8c">&#34;name&#34;</span>: tool<span style="color:#ff79c6">.</span>name,
</span></span><span style="display:flex;"><span>                    <span style="color:#f1fa8c">&#34;description&#34;</span>: tool<span style="color:#ff79c6">.</span>description,
</span></span><span style="display:flex;"><span>                    <span style="color:#f1fa8c">&#34;parameters&#34;</span>: tool<span style="color:#ff79c6">.</span>inputSchema,
</span></span><span style="display:flex;"><span>                },
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">for</span> tool <span style="color:#ff79c6">in</span> response<span style="color:#ff79c6">.</span>tools
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Initial OpenAI API call</span>
</span></span><span style="display:flex;"><span>        response <span style="color:#ff79c6">=</span> self<span style="color:#ff79c6">.</span>openai<span style="color:#ff79c6">.</span>chat<span style="color:#ff79c6">.</span>completions<span style="color:#ff79c6">.</span>create(
</span></span><span style="display:flex;"><span>            model<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;deepseek-chat&#34;</span>,
</span></span><span style="display:flex;"><span>            max_tokens<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1000</span>,
</span></span><span style="display:flex;"><span>            messages<span style="color:#ff79c6">=</span>messages,
</span></span><span style="display:flex;"><span>            tools<span style="color:#ff79c6">=</span>available_tools,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Process response and handle tool calls</span>
</span></span><span style="display:flex;"><span>        final_text <span style="color:#ff79c6">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        assistant_message <span style="color:#ff79c6">=</span> response<span style="color:#ff79c6">.</span>choices[<span style="color:#bd93f9">0</span>]<span style="color:#ff79c6">.</span>message
</span></span><span style="display:flex;"><span>        assistant_message_content <span style="color:#ff79c6">=</span> assistant_message<span style="color:#ff79c6">.</span>content <span style="color:#ff79c6">or</span> <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> assistant_message_content:
</span></span><span style="display:flex;"><span>            final_text<span style="color:#ff79c6">.</span>append(assistant_message_content)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Handle tool calls if present</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> assistant_message<span style="color:#ff79c6">.</span>tool_calls:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">for</span> tool_call <span style="color:#ff79c6">in</span> assistant_message<span style="color:#ff79c6">.</span>tool_calls:
</span></span><span style="display:flex;"><span>                tool_name <span style="color:#ff79c6">=</span> tool_call<span style="color:#ff79c6">.</span>function<span style="color:#ff79c6">.</span>name
</span></span><span style="display:flex;"><span>                tool_args <span style="color:#ff79c6">=</span> tool_call<span style="color:#ff79c6">.</span>function<span style="color:#ff79c6">.</span>arguments
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4"># 将 JSON 字符串转换为字典对象</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">isinstance</span>(tool_args, <span style="color:#8be9fd;font-style:italic">str</span>):
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>                        tool_args_dict <span style="color:#ff79c6">=</span> json<span style="color:#ff79c6">.</span>loads(tool_args)
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">except</span> json<span style="color:#ff79c6">.</span>JSONDecodeError:
</span></span><span style="display:flex;"><span>                        tool_args_dict <span style="color:#ff79c6">=</span> {<span style="color:#f1fa8c">&#34;text&#34;</span>: tool_args}
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>                    tool_args_dict <span style="color:#ff79c6">=</span> tool_args
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4"># Execute tool call</span>
</span></span><span style="display:flex;"><span>                result <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> self<span style="color:#ff79c6">.</span>session<span style="color:#ff79c6">.</span>call_tool(tool_name, tool_args_dict)
</span></span><span style="display:flex;"><span>                final_text<span style="color:#ff79c6">.</span>append(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;[调用工具 </span><span style="color:#f1fa8c">{</span>tool_name<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">，参数 </span><span style="color:#f1fa8c">{</span>tool_args<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">]&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4"># Add assistant message and tool result to messages</span>
</span></span><span style="display:flex;"><span>                messages<span style="color:#ff79c6">.</span>append(
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        <span style="color:#f1fa8c">&#34;role&#34;</span>: <span style="color:#f1fa8c">&#34;assistant&#34;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#f1fa8c">&#34;content&#34;</span>: <span style="color:#ff79c6">None</span>,  <span style="color:#6272a4"># 设置为 None，因为我们使用 tool_calls</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f1fa8c">&#34;tool_calls&#34;</span>: [
</span></span><span style="display:flex;"><span>                            {
</span></span><span style="display:flex;"><span>                                <span style="color:#f1fa8c">&#34;id&#34;</span>: tool_call<span style="color:#ff79c6">.</span>id,
</span></span><span style="display:flex;"><span>                                <span style="color:#f1fa8c">&#34;type&#34;</span>: <span style="color:#f1fa8c">&#34;function&#34;</span>,
</span></span><span style="display:flex;"><span>                                <span style="color:#f1fa8c">&#34;function&#34;</span>: {<span style="color:#f1fa8c">&#34;name&#34;</span>: tool_name, <span style="color:#f1fa8c">&#34;arguments&#34;</span>: tool_args},
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                        ],
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4"># 工具结果消息必须使用字符串内容</span>
</span></span><span style="display:flex;"><span>                messages<span style="color:#ff79c6">.</span>append(
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        <span style="color:#f1fa8c">&#34;role&#34;</span>: <span style="color:#f1fa8c">&#34;tool&#34;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#f1fa8c">&#34;tool_call_id&#34;</span>: tool_call<span style="color:#ff79c6">.</span>id,
</span></span><span style="display:flex;"><span>                        <span style="color:#f1fa8c">&#34;content&#34;</span>: <span style="color:#8be9fd;font-style:italic">str</span>(result<span style="color:#ff79c6">.</span>content),  <span style="color:#6272a4"># 确保内容是字符串</span>
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4"># Get next response from OpenAI</span>
</span></span><span style="display:flex;"><span>                response <span style="color:#ff79c6">=</span> self<span style="color:#ff79c6">.</span>openai<span style="color:#ff79c6">.</span>chat<span style="color:#ff79c6">.</span>completions<span style="color:#ff79c6">.</span>create(
</span></span><span style="display:flex;"><span>                    model<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;deepseek-chat&#34;</span>,
</span></span><span style="display:flex;"><span>                    max_tokens<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1000</span>,
</span></span><span style="display:flex;"><span>                    messages<span style="color:#ff79c6">=</span>messages,
</span></span><span style="display:flex;"><span>                    tools<span style="color:#ff79c6">=</span>available_tools,
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                next_content <span style="color:#ff79c6">=</span> response<span style="color:#ff79c6">.</span>choices[<span style="color:#bd93f9">0</span>]<span style="color:#ff79c6">.</span>message<span style="color:#ff79c6">.</span>content <span style="color:#ff79c6">or</span> <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">if</span> next_content:
</span></span><span style="display:flex;"><span>                    final_text<span style="color:#ff79c6">.</span>append(next_content)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">.</span>join(final_text)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">chat_loop</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Run an interactive chat loop&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">MCP 客户端已启动！&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;输入您的问题或输入 &#39;quit&#39; 退出。&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">True</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>                query <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">input</span>(<span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">问题: &#34;</span>)<span style="color:#ff79c6">.</span>strip()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">if</span> query<span style="color:#ff79c6">.</span>lower() <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;quit&#34;</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                response <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> self<span style="color:#ff79c6">.</span>process_query(query)
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#ff79c6">+</span> response)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">except</span> Exception <span style="color:#ff79c6">as</span> e:
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">错误: </span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">str</span>(e)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">import</span> traceback
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                traceback<span style="color:#ff79c6">.</span>print_exc()  <span style="color:#6272a4"># 打印完整的错误堆栈，帮助调试</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">cleanup</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Clean up resources&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">await</span> self<span style="color:#ff79c6">.</span>exit_stack<span style="color:#ff79c6">.</span>aclose()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">main</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">len</span>(sys<span style="color:#ff79c6">.</span>argv) <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">1</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;用法: python client.py&#34;</span>)
</span></span><span style="display:flex;"><span>        sys<span style="color:#ff79c6">.</span>exit(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    client <span style="color:#ff79c6">=</span> MCPClient()
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">await</span> client<span style="color:#ff79c6">.</span>connect_to_server()
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">await</span> client<span style="color:#ff79c6">.</span>chat_loop()
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">finally</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">await</span> client<span style="color:#ff79c6">.</span>cleanup()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> __name__ <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">import</span> sys
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    asyncio<span style="color:#ff79c6">.</span>run(main())
</span></span></code></pre></div><h2 id="33-调试mcp">3.3 调试MCP</h2>
<p>官方提供几个调试工具用于不同级别的debug：</p>
<ol>
<li>MCP Inspector(个人推荐)</li>
<li>Claude Desktop开发者工具</li>
<li>Server端打印日志</li>
</ol>
<p>如何使用<code>MCP Inspector</code>调试MCP？
<code>MCP Inspector</code>是一款用于测试和调试MCP Server的交互式开发者工具，可以通过<code>npx</code>启动。实际上是一个通用版的web MCP Client，用于调试各种不同的MCP Server，包括本地的MCP Server，以及远程的MCP Server。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#6272a4"># 语法格式</span>
</span></span><span style="display:flex;"><span>npx @modelcontextprotocol/inspector <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  uv <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --directory path/to/server <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  run <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  package-name <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  args...
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff79c6">(</span>mcp-client<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">(</span>base<span style="color:#ff79c6">)</span> iceyao@macbookair Desktop % npx @modelcontextprotocol/inspector <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  uv <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --directory <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  /Users/iceyao/Desktop/weather <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  run <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  weather.py
</span></span><span style="display:flex;"><span>Starting MCP inspector...
</span></span><span style="display:flex;"><span>⚙️ Proxy server listening on port <span style="color:#bd93f9">6277</span>
</span></span><span style="display:flex;"><span>New SSE connection
</span></span><span style="display:flex;"><span>Query parameters: <span style="color:#ff79c6">[</span>Object: null prototype<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>  transportType: <span style="color:#f1fa8c">&#39;stdio&#39;</span>,
</span></span><span style="display:flex;"><span>  command: <span style="color:#f1fa8c">&#39;uv&#39;</span>,
</span></span><span style="display:flex;"><span>  args: <span style="color:#f1fa8c">&#39;--directory /Users/iceyao/Desktop/weather run weather.py&#39;</span>,
</span></span><span style="display:flex;"><span>  env: <span style="color:#f1fa8c">&#39;{&#34;HOME&#34;:&#34;/Users/iceyao&#34;,&#34;LOGNAME&#34;:&#34;iceyao&#34;,&#34;PATH&#34;:&#34;/Users/iceyao/.npm/_npx/5a9d879542beca3a/node_modules/.bin:/Users/iceyao/Desktop/node_modules/.bin:/Users/iceyao/node_modules/.bin:/Users/node_modules/.bin:/node_modules/.bin:/opt/homebrew/lib/node_modules/npm/node_modules/@npmcli/run-script/lib/node-gyp-bin:/Users/iceyao/Desktop/mcp-client/.venv/bin:/Users/iceyao/.local/bin:/usr/local/go/bin/:/Users/iceyao/Documents//bin:/opt/anaconda3/bin:/opt/anaconda3/condabin:/opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/bin:/System/Cryptexes/App/usr/bin:/usr/bin:/bin:/usr/sbin:/sbin:/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/local/bin:/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/bin:/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/appleinternal/bin:/Applications/iTerm.app/Contents/Resources/utilities:/Users/iceyao/.orbstack/bin&#34;,&#34;SHELL&#34;:&#34;/bin/zsh&#34;,&#34;TERM&#34;:&#34;xterm-256color&#34;,&#34;USER&#34;:&#34;iceyao&#34;}&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>Stdio transport: <span style="color:#8be9fd;font-style:italic">command</span><span style="color:#ff79c6">=</span>/Users/iceyao/.local/bin/uv, <span style="color:#8be9fd;font-style:italic">args</span><span style="color:#ff79c6">=</span>--directory,/Users/iceyao/Desktop/weather,run,weather.py
</span></span><span style="display:flex;"><span>Spawned stdio transport
</span></span><span style="display:flex;"><span>Connected MCP client to backing server transport
</span></span><span style="display:flex;"><span>Created web app transport
</span></span><span style="display:flex;"><span>Created web app transport
</span></span><span style="display:flex;"><span>Set up MCP proxy
</span></span><span style="display:flex;"><span>🔍 MCP Inspector is up and running at http://127.0.0.1:6274 🚀
</span></span></code></pre></div><p>浏览器访问<a href="http://127.0.0.1:6274">http://127.0.0.1:6274</a></p>
<h2 id="34-mcp其它概念">3.4 MCP其它概念</h2>
<p>上述MCP Server/Client的示例和调试过程主要聚焦于Tools功能的实现和使用。虽然目前大多数MCP的实现都是围绕Tools展开的，但MCP协议实际上还包含其他重要概念</p>
<h3 id="341-资源resources">3.4.1 资源Resources</h3>
<p>Resources：将服务器中的数据和内容提供给大语言模型（LLMs），它是模型上下文协议（MCP）中的核心基本要素，它使服务器能够提供可被客户端读取的数据和内容，并用作与大语言模型交互的上下文。</p>
<p>到底哪些内容可以被视为Resources？诸如文件内容、数据库记录、API响应、实时系统数据、截图和图像、日志文件等，都可以被视为Resources。可以归类为两大类型内容：</p>
<ul>
<li>文本资源：源代码、配置文件、日志文件、JSON/XML数据、文本</li>
<li>二进制资源：图片、PDF、音频文件、视频文件、其它非文本格式</li>
</ul>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>mcp <span style="color:#ff79c6">=</span> FastMCP(<span style="color:#f1fa8c">&#34;weather&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@mcp.resource(<span style="color:#f1fa8c">&#34;file:///tmp/app.log&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">read_resource</span>() <span style="color:#ff79c6">-&gt;</span> <span style="color:#8be9fd;font-style:italic">str</span>:
</span></span><span style="display:flex;"><span>    log_contents <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> read_log_file()
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> log_contents
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@mcp.resource(<span style="color:#f1fa8c">&#34;echo://</span><span style="color:#f1fa8c">{text}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">echo_template</span>(text: <span style="color:#8be9fd;font-style:italic">str</span>) <span style="color:#ff79c6">-&gt;</span> <span style="color:#8be9fd;font-style:italic">str</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;&#34;&#34;Echo the input text&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;Echo: </span><span style="color:#f1fa8c">{</span>text<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>
</span></span></code></pre></div><p>通过mcp sdk的<code>ClientSession</code>的<code>read_resource</code>方法可以读取资源</p>
<h3 id="342-提示词prompts">3.4.2 提示词Prompts</h3>
<p>Prompts：创建可复用的提示模板和工作流程，客户端可以轻松地将其呈现给用户和大语言模型（LLMs）。它们提供了一种强大的方式来规范和共享常见的大语言模型交互；Prompts旨在由用户控制。</p>
<p>MCP中的Prompts是预定义的模板，这些模板能够：</p>
<ul>
<li>接受动态参数</li>
<li>包含来自资源的上下文</li>
<li>串联多个交互</li>
<li>引导特定workflow</li>
<li>显示为用户界面元素（比如斜杠命令）</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>mcp <span style="color:#ff79c6">=</span> FastMCP(<span style="color:#f1fa8c">&#34;weather&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@mcp.prompt(<span style="color:#f1fa8c">&#34;echo&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">echo_prompt</span>(text: <span style="color:#8be9fd;font-style:italic">str</span>) <span style="color:#ff79c6">-&gt;</span> <span style="color:#8be9fd;font-style:italic">str</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> text
</span></span></code></pre></div><p>通过mcp sdk的<code>ClientSession</code>的<code>get_prompt</code>方法可以读取prompt</p>
<h3 id="343-工具tools">3.4.3 工具Tools</h3>
<p>Tools是模型上下文协议（MCP）中一种强大的基本元素，它使服务器能够向客户端公开可执行功能。通过工具，大语言模型可以与外部系统交互、进行计算，并在现实世界中采取行动。</p>
<p>Tools的实现例子如上MCP Server、Client的示例，目前大多数的MCP Client只支持Tools的调用，比如cursor、winsurf等</p>
<h3 id="344-采样sampling">3.4.4 采样Sampling</h3>
<p>Sampling是MCP的一项强大功能，它允许服务器通过客户端向大语言模型请求完成结果，在维护安全和隐私的同时实现复杂的智能行为。(示例待补充)</p>
<h3 id="345-roots">3.4.5 Roots</h3>
<p>Roots是MCP中的一个概念，用于定义服务器可以运行的边界。它们为客户端向服务器告知相关资源及其位置提供了一种方式。(示例待补充)</p>
<h1 id="4-mcp未来展望">4. MCP未来展望</h1>
<p>从MCP官网路线图获悉大致未来6个月的方向：</p>
<h2 id="41-validation">4.1 Validation</h2>
<ul>
<li>计划投资于参考客户端实现，用于展示协议功能的高质量AI应用</li>
<li>开发合规测试套件，用于自动验证客户端、服务器和SDK是否正确实现规范</li>
<li>这些工具将帮助开发者自信地实现MCP，同时确保整个生态系统中的行为一致性</li>
</ul>
<h2 id="42-registry">4.2 Registry</h2>
<ul>
<li>计划开发MCP Registry，实现集中式服务器发现和元数据管理</li>
<li>该Registry将主要作为API层，供第三方市场和发现服务构建使用</li>
<li>目标是简化MCP服务器的分发和发现方式</li>
</ul>
<h2 id="43-agents智能体">4.3 Agents（智能体）</h2>
<ul>
<li>探索改进如Agent Graphs（智能体图），通过命名空间和图感知通信模式实现复杂的智能体拓扑结构</li>
<li>改进交互式工作流，通过精细权限管理、标准化交互模式和与终端用户直接通信的方式，提升人机协作体验</li>
<li>随着MCP越来越多地成为智能体工作流的一部分，这些改进将变得更加重要</li>
</ul>
<h2 id="44-multimodality多模态">4.4 Multimodality（多模态）</h2>
<ul>
<li>支持AI能力的完整范围，包括视频和其他媒体类型</li>
<li>实现流式处理，包括多部分、分块消息和双向通信，以提供交互式体验</li>
</ul>
<h2 id="45-governance治理">4.5 Governance（治理）</h2>
<ul>
<li>实施以社区为主导的开发，培养协作生态系统，确保MCP服务于多样化的应用和用例</li>
<li>建立透明的标准化流程，用于规范贡献，同时探索通过行业机构进行正式标准化</li>
</ul>
<h1 id="参考链接">参考链接</h1>
<ul>
<li><a href="https://modelcontextprotocol.io/introduction">https://modelcontextprotocol.io/introduction</a></li>
<li><a href="https://github.com/modelcontextprotocol/python-sdk/tree/main/examples">mcp-server python sdk例子</a></li>
<li><a href="https://modelcontextprotocol.io/development/roadmap">https://modelcontextprotocol.io/development/roadmap</a></li>
<li><a href="https://docs.cline.bot/mcp-servers/configuring-mcp-servers">Cline Configuring MCP Servers</a></li>
</ul>


                
                
<div class="entry-shang text-center">
    
	    <p>「真诚赞赏，手留余香」</p>
	
	<button class="zs show-zs btn btn-bred">赞赏支持</button>
</div>
<div class="zs-modal-bg"></div>
<div class="zs-modal-box">
	<div class="zs-modal-head">
		<button type="button" class="close">×</button>
		<span class="author"><a href="https://www.iceyao.com.cn/"><img src="/img/favicon.png" />爱折腾的工程师</a></span>
        
	        <p class="tip"><i></i><span>真诚赞赏，手留余香</span></p>
		
 
	</div>
	<div class="zs-modal-body">
		<div class="zs-modal-btns">
			<button class="btn btn-blink" data-num="2">2元</button>
			<button class="btn btn-blink" data-num="5">5元</button>
			<button class="btn btn-blink" data-num="10">10元</button>
			<button class="btn btn-blink" data-num="50">50元</button>
			<button class="btn btn-blink" data-num="100">100元</button>
			<button class="btn btn-blink" data-num="1">任意金额</button>
		</div>
		<div class="zs-modal-pay">
			<button class="btn btn-bred" id="pay-text">2元</button>
			<p>使用<span id="pay-type">微信</span>扫描二维码完成支付</p>
			<img src="/img/reward/wechat-2.png"  id="pay-image"/>
		</div>
	</div>
	<div class="zs-modal-footer">
		<label><input type="radio" name="zs-type" value="wechat" class="zs-type" checked="checked"><span ><span class="zs-wechat"><img src="/img/reward/wechat-btn.png"/></span></label>
		<label><input type="radio" name="zs-type" value="alipay" class="zs-type" class="zs-alipay"><img src="/img/reward/alipay-btn.png"/></span></label>
	</div>
</div>
<script type="text/javascript" src="/js/reward.js"></script>

                

                
                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2025/02/10/vllm-readnotes/" data-toggle="tooltip" data-placement="top" title="vLLM学习笔记(AI编程工具分析)">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                </ul>
                

                


<script src="https://giscus.app/client.js"
        data-repo="yaoice/yaoice.github.io"
        data-repo-id="R_kgDOJnxqVg"
        data-category="General"
        data-category-id="DIC_kwDOJnxqVs4CWwUs"
        data-mapping="pathname"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-theme="light"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>


            </div>

            
            
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
            

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                        
                        
                        
                        
                        
                        <a href="/tags/devops" title="devops">
                            devops
                        </a>
                        
                        
                        
                        <a href="/tags/go" title="go">
                            go
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/k8s" title="k8s">
                            k8s
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/llm" title="llm">
                            llm
                        </a>
                        
                        
                        
                        <a href="/tags/openstack" title="openstack">
                            openstack
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/tkestack" title="tkestack">
                            tkestack
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/%E7%BB%83%E8%BD%A6" title="练车">
                            练车
                        </a>
                        
                        
                    </div>
                </section>
                

                
                
            </div>
        </div>
    </div>
</article>





  
<script type="module">  
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs'; 
    mermaid.initialize({ startOnLoad: true });  
</script>  
<script>  
    
    Array.from(document.getElementsByClassName("language-mermaid")).forEach(  
        (el) => {  
            el.parentElement.outerHTML = `<div class="mermaid">${el.innerHTML}</div>`;  
        }  
    );  
</script>  
<style>  
       
    .mermaid svg {  
        display: block;  
        margin: auto;  
    }  
</style>  




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">                  
                    
                    <li>
                        <a href="mailto:yao3690093@gmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    
                    
                    

		            
                    
                    <li>
                        <a target="_blank" href="/img/wechat.jpeg">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-weixin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    <li>
                        <a target="_blank" href="https://github.com/yaoice">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    
                    
                    
                    
                    
                    
                    
                    
            
            
            
           
                   <li>
                       <a href="/index.xml" rel="alternate" type="application/rss+xml" title="爱折腾的工程师" >
                           <span class="fa-stack fa-lg">
                               <i class="fas fa-circle fa-stack-2x"></i>
                               <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                           </span>
                       </a>
                   </li>
            
             </ul>
		<p class="copyright text-muted">
                    Copyright &copy; 爱折腾的工程师 2025
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>



<script>
    (function(){
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https'){
       bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
      }
      else{
      bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>


<script>
    
    var _baId = '92c175994ded75a3cd2074bc1123e2be';

    
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?" + _baId;
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
</script>




<script type="text/javascript">
    function generateCatalog(selector) {

        
        
        
        
            _containerSelector = 'div.post-container'
        

        
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        
        $(selector).html('')

        
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    


    loadAsync("\/js\/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>







</body>
</html>
